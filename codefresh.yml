version: "1.0"
mode: parallel

stages:
  - setup
  - ZD-9936
  - cleanup

steps:
  clone:
    title: "Cloning repository"
    type: "git-clone"
    repo: "lrochette/ptm-tests"
    revision: "main"
    stage: setup

  create_project:
    title: "creating the test project"
    image: codefresh/cli
    stage: setup
    fail_fast: false
    commands:
      - export CF_API_KEY=${{MY_API_KEY}}
      - codefresh create project ptm -t test -t ptm

  ZD-9936:
    type: pipeline-trigger-merge
    title: "ZD-9936"
    working_directory: ${{clone}}/ZD-9336
    stage: ZD-9936
    arguments:
      SPEC: spec.yaml
      TRIGGERS: trig.yaml
      CF_API_KEY: ${{MY_API_KEY}}
    when:
      steps:
        - name: clone
          on:
            - success
        - name: create_project
          on:
            - finished
  cat-ZD9936:
    title: "Display ZD-9936 pipeline"
    image: codefresh/cli
    working_directory: ${{clone}}/ZD-9336
    stage: ZD-9936
    commands:
      - cat spec.yaml
    when:
      steps:
        - name: ZD-9936
          on:
            - finished
  delete-ZD9936:
    title: deleting the pipeline created
    image: codefresh/cli
    stage: ZD-9936
    commands:
      - export CF_API_KEY=${{MY_API_KEY}}
      - codefresh delete project ptm
    when:
      steps:
        - name: ZD-9936
          on:
            - success

  cleanup:
    title: creating the test project
    image: codefresh/cli
    stage: cleanup
    commands:
      - export CF_API_KEY=${{MY_API_KEY}}
      - codefresh delete project ptm
    when:
      steps:
        - name: ZD-9936
          on:
            - success
