version: "1.0"
mode: parallel

stages:
  - setup
  - ZD-9336-test1
  - ZD-9336-test2
  - cleanup

steps:
  clone:
    title: "Cloning repository"
    type: "git-clone"
    repo: "lrochette/ptm-tests"
    revision: "main"
    stage: setup

  create_project:
    title: "creating the test project"
    image: codefresh/cli
    stage: setup
    fail_fast: false
    commands:
      - export CF_API_KEY=${{MY_API_KEY}}
      - codefresh create project ptm -t test -t ptm

  GettingPluginVersion:
    title: Getting Plugin Version
    image: codefresh/cli
    stage: setup
    working_directory: "${{clone}}/step"
    commands:
      - cf_export PLUGIN_VERSION=$(yq -r .metadata.version ./step.yaml)

  ZD-9336-test1:
    type: laurent-cf/pipeline-trigger-merge
    title: "ZD-9336-test1 - on is quoted"
    working_directory: ${{clone}}/ZD-9336/test1
    stage: ZD-9336-test1
    arguments:
      SPEC: spec.yaml
      TRIGGERS: trig.yaml
      CF_API_KEY: ${{MY_API_KEY}}
    when:
      steps:
        all:
          - name: clone
            'on':
              - success
          - name: create_project
            on:
              - finished
  ZD-9336-test2:
    type: laurent-cf/pipeline-trigger-merge
    title: "ZD-9336-test2 - on is unquoted"
    working_directory: ${{clone}}/ZD-9336/test2
    stage: ZD-9336-test2
    arguments:
      SPEC: spec.yaml
      TRIGGERS: trig.yaml
      CF_API_KEY: ${{MY_API_KEY}}
    when:
      steps:
        all:
          - name: clone
            'on':
              - success
          - name: create_project
            on:
              - finished
  run-ZD9336-test1:
    title: Running the pipeline created
    type: codefresh-run
    stage: ZD-9336-test1
    arguments:
      PIPELINE_ID: ptm/ZD9336-test1
      TRIGGER_ID: trig1
      BRANCH: main
    when:
      steps:
        - name: ZD-9336-test1
          on:
            - success
  run-ZD9336-test2:
    title: Running the pipeline created
    type: codefresh-run
    stage: ZD-9336-test2
    arguments:
      PIPELINE_ID: ptm/ZD9336-test2
      TRIGGER_ID: trig1
      BRANCH: main
    when:
      steps:
        - name: ZD-9336-test2
          on:
            - success

  delete-ZD9336-pipelines:
    title: deleting the pipeline created
    image: codefresh/cli
    stage: cleanup
    commands:
      - export CF_API_KEY=${{MY_API_KEY}}
      - codefresh delete pip ptm/ZD9336-test1
      - codefresh delete pip ptm/ZD9336-test2
    when:
      steps:
        all:
          - name: run-ZD9336-test1
            on:
              - finished
          - name: run-ZD9336-test2
            on:
              - finished
  cleanup:
    title: Deleting the test project
    image: codefresh/cli
    stage: cleanup
    commands:
      - export CF_API_KEY=${{MY_API_KEY}}
      - codefresh delete project ptm
    when:
      steps:
        - name: delete-ZD9336-pipelines
          on:
            - success
